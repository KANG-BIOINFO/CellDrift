<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CellDrift._model &mdash; CellDrift 0.1.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> CellDrift
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apis.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../related_research.html">Related Research</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CellDrift</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>CellDrift._model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CellDrift._model</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="kn">import</span> <span class="n">dmatrix</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multitest</span> <span class="kn">import</span> <span class="n">fdrcorrection</span>
<span class="kn">from</span> <span class="nn">scipy.stats.distributions</span> <span class="kn">import</span> <span class="n">chi2</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>

<span class="kn">from</span> <span class="nn">._setup</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_covar_name</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">key_celltype</span><span class="p">,</span> <span class="n">key_perturb</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get metadata for coefficients. Four levels are included now, including</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">covar_name_describe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;celltype&#39;</span><span class="p">,</span><span class="s1">&#39;perturb&#39;</span><span class="p">,</span> <span class="s1">&#39;x_label&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">:</span>
            <span class="n">covar_name_describe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;intercept&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">key_celltype</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key_perturb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">covar_name_describe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;celltype&#39;</span><span class="p">,</span> 
                                          <span class="n">i</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39;[T.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">),</span> 
                                          <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                          <span class="n">i</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39;[T.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">key_celltype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key_perturb</span> <span class="ow">in</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">covar_name_describe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;perturb&#39;</span><span class="p">,</span> 
                                          <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                          <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">key_celltype</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key_perturb</span> <span class="ow">in</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">covar_name_describe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;celltype:perturb&#39;</span><span class="p">,</span> 
                                          <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39;[T.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">),</span> 
                                          <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39;[T.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">covar_name_describe</span>

<span class="k">def</span> <span class="nf">prepare_output</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>  
    <span class="c1"># load data</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">df_all</span><span class="p">,</span> <span class="n">df_pairwiseComp_all</span><span class="p">,</span> <span class="n">n_coeffs</span><span class="p">,</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">pairwise_contrast_only</span> <span class="o">=</span> <span class="n">args</span>

    <span class="c1"># 1. format original output</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_coeffs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;x_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="n">n_coeffs</span><span class="p">]</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;coefficient_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffs</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;n_coefficients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">genes</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># subset of genes which were fitted successfully using GLM.</span>

    <span class="n">df_mu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)]))</span>
    <span class="n">df_sigma</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;standard err&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)]))</span>
    <span class="n">df_pvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;pvals&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)]))</span>
    <span class="n">df_LRT_pval</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LRT_pval&#39;</span><span class="p">],</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;LRT_pval&#39;</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)))]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pairwise_contrast_only</span><span class="p">:</span>
        <span class="n">df_mu</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;GLM_output_parameters&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">df_sigma</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;GLM_output_standard_errors&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">df_pvals</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;GLM_output_pvals&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">df_LRT_pval</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;GLM_output_LRT_pvals&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># 2. format pairwise comparison analysis (multiple comparison)</span>
    <span class="n">n_pairwise_terms</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key_perturb</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key_celltype</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">df_pairwiseComp_all</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="n">n_pairwise_terms</span><span class="p">]</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;multicomp_terms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">terms</span>

    <span class="n">df_multicomp_mu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">terms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pairwiseComp_all</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)]))</span>
    <span class="n">df_multicomp_SE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">terms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pairwiseComp_all</span><span class="p">[</span><span class="s1">&#39;SE&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)]))</span>
    <span class="n">df_multicomp_lci</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">terms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pairwiseComp_all</span><span class="p">[</span><span class="s1">&#39;lci&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)]))</span>
    <span class="n">df_multicomp_uci</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">terms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pairwiseComp_all</span><span class="p">[</span><span class="s1">&#39;uci&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)]))</span>
    <span class="n">df_multicomp_pvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">terms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_pairwiseComp_all</span><span class="p">[</span><span class="s1">&#39;p_fdr&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)]))</span>

    <span class="c1"># add information to anndata</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;GLM_raw_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mu</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;GLM_raw_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sigma</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;GLM_raw_pvals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pvals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;Contrast_Coefficients_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_multicomp_mu</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;Contrast_Coefficients_SE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_multicomp_SE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;Contrast_Coefficients_lci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_multicomp_lci</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;Contrast_Coefficients_uci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_multicomp_uci</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;Contrast_Coefficients_pvals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_multicomp_pvals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;LRT_pvals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_LRT_pval</span><span class="p">[</span><span class="s1">&#39;LRT_pval&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">adata</span>

<span class="k">def</span> <span class="nf">LRT</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">):</span>
    <span class="n">LR</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">L1</span><span class="o">-</span><span class="n">L2</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">emmeans</span><span class="p">(</span><span class="n">df_input</span><span class="p">,</span> <span class="n">betas</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">key_cell</span><span class="p">,</span> <span class="n">key_perturb</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Applying emmeans package in GLM model for post-hoc analysis.</span>
<span class="sd">    Adapt from https://glennwilliams.me/blog/2021/09/07/estimating-marginal-means-and-pairwise-tests-by-hand-in-python/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_input</span>
<span class="sd">        input of GLM model</span>
<span class="sd">    betas</span>
<span class="sd">        inferred coefficients from the model</span>
<span class="sd">    v</span>
<span class="sd">        variance-covariance matrix of coefficients</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># levels</span>
    <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_input</span><span class="p">[</span><span class="n">key_cell</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
    <span class="n">n_perturbs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_input</span><span class="p">[</span><span class="n">key_perturb</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">df_input</span><span class="p">[</span><span class="n">key_cell</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">),</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">df_input</span><span class="p">[</span><span class="n">key_perturb</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
    <span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_perturbs</span> <span class="o">*</span> <span class="n">n_types</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;stim&#39;</span><span class="p">])</span> <span class="c1"># rename them into cell and stim purposely</span>

    <span class="c1"># matrix</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">dmatrix</span><span class="p">(</span>
        <span class="s1">&#39;C(cell, Treatment(0))*C(stim, Treatment(0))&#39;</span><span class="p">,</span> 
        <span class="n">grid</span><span class="p">,</span> 
        <span class="n">return_type</span> <span class="o">=</span> <span class="s1">&#39;matrix&#39;</span>
    <span class="p">)</span>

    <span class="n">emmeans</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="c1"># emmeans[&#39;means&#39;] = mat @ betas # not necessary</span>
    
    <span class="c1"># variance-covariance matrix</span>
    <span class="n">vcov</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">vcov</span> <span class="o">=</span> <span class="n">vcov</span><span class="p">[</span><span class="o">~</span><span class="n">vcov</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;Var|Cor&#39;</span><span class="p">)]</span>
    <span class="n">vcov</span> <span class="o">=</span> <span class="n">vcov</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">vcov</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;Var|Cor&#39;</span><span class="p">)]</span>

    <span class="c1"># emmeans[&#39;SE&#39;] = np.sqrt(np.diagonal(mat @ vcov) @ mat.T) # not necessary</span>

    <span class="c1"># making pairwise mean difference</span>
    <span class="n">combo_names</span> <span class="o">=</span> <span class="n">emmeans</span><span class="o">.</span><span class="n">cell</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">emmeans</span><span class="o">.</span><span class="n">stim</span>
    <span class="n">contrast_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">combo_names</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">combo_names_dummy</span> <span class="o">=</span> <span class="n">emmeans</span><span class="o">.</span><span class="n">cell</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">emmeans</span><span class="o">.</span><span class="n">stim</span>
    <span class="n">contrast_pairs_dummy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">combo_names_dummy</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="c1"># dummy names</span>
    
    <span class="n">contrast_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cell_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">perturb_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">names</span><span class="p">,</span> <span class="n">names_dummy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contrast_pairs</span><span class="p">,</span> <span class="n">contrast_pairs_dummy</span><span class="p">):</span>
        <span class="n">contrast_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
        <span class="n">cell_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">names_dummy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">names_dummy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">perturb_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">names_dummy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">names_dummy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="n">limits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combo_names</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">combo_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">combo_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">combo_cols</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">])</span>

    <span class="n">model_pairwise_contrasts</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">combo_cols</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">combo_cols</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">model_pairwise_contrasts</span> <span class="o">=</span> <span class="n">model_pairwise_contrasts</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># calculate contrast means</span>
    <span class="n">pairwise</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">contrast_names</span><span class="p">,</span> <span class="n">cell_names</span><span class="p">,</span> <span class="n">perturb_names</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;contrast&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_type&#39;</span><span class="p">,</span> <span class="s1">&#39;perturbation&#39;</span><span class="p">])</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">betas</span> <span class="o">@</span> <span class="n">model_pairwise_contrasts</span><span class="p">)</span>

    <span class="c1"># calculate contrast se </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pairwise</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">grad_g</span> <span class="o">=</span> <span class="n">model_pairwise_contrasts</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">pairwise</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">grad_g</span> <span class="o">@</span> <span class="n">vcov</span> <span class="o">@</span> <span class="n">grad_g</span><span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>
    
    <span class="c1"># calculate constrast z score and p value</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;SE&#39;</span><span class="p">]</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>

    <span class="n">confint</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span>
        <span class="mf">0.95</span><span class="p">,</span> 
        <span class="n">loc</span><span class="o">=</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> 
        <span class="n">scale</span><span class="o">=</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;SE&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;lci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;uci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">confint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">pairwise</span> <span class="o">=</span> <span class="n">pairwise</span><span class="p">[[</span>
        <span class="s1">&#39;contrast&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;perturbation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mean&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;lci&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;uci&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;SE&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;z&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;p&#39;</span>
    <span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># p value adjustment using FDR correction</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;p_fdr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdrcorrection</span><span class="p">(</span><span class="n">pvals</span> <span class="o">=</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># subset</span>
    <span class="n">selected_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ctrl</span><span class="p">)]</span>
    <span class="n">selected_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="c1"># reverse contrasts (make sure the ref is control)</span>
    <span class="n">pairwise</span> <span class="o">=</span> <span class="n">pairwise</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_p</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_c</span><span class="p">)),</span> <span class="p">:]</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;lci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;lci&#39;</span><span class="p">]</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;uci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;uci&#39;</span><span class="p">]</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">]]</span>
    <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;contrast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">],</span> <span class="n">pairwise</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">])]</span>
    <span class="n">pairwise</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;contrast&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pairwise</span>

<span class="k">def</span> <span class="nf">glm_gene_chunk</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span> <span class="n">df_input</span><span class="p">,</span> <span class="n">adjust_batch</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">add_dummy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get GLM models for genes in a chunk during multiprocessing</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># add dummy values</span>
    <span class="k">if</span> <span class="n">add_dummy</span><span class="p">:</span>
        <span class="mi">1</span>

    <span class="n">df_output_chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df_pairwiseComp_chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1"># build the glm model</span>
    <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">genes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">adjust_batch</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s1">&#39; ~ &#39;</span> <span class="o">+</span> <span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">key_perturb</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">key_batch</span>
            <span class="n">formula_ref</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s1">&#39; ~ &#39;</span> <span class="o">+</span> <span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">key_perturb</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">key_batch</span> <span class="c1"># reference glm model without interaction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s1">&#39; ~ &#39;</span> <span class="o">+</span> <span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="n">key_perturb</span>
            <span class="n">formula_ref</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s1">&#39; ~ &#39;</span> <span class="o">+</span> <span class="n">key_celltype</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">key_perturb</span> <span class="c1"># reference glm model without interaction</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># glm_result = smf.glm(formula = formula,</span>
            <span class="c1">#                     offset = np.log(df_input[key_size_factor]), </span>
            <span class="c1">#                     data = df_input,</span>
            <span class="c1">#                     family = sm.families.NegativeBinomial()).fit(method=&#39;lbfgs&#39;)</span>

            <span class="c1"># glm_ref_result = smf.glm(formula = formula_ref,</span>
            <span class="c1">#                             offset = np.log(df_input[key_size_factor]), </span>
            <span class="c1">#                             data = df_input,</span>
            <span class="c1">#                             family = sm.families.NegativeBinomial()).fit(method=&#39;lbfgs&#39;)</span>

            <span class="n">glm_result</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">glm</span><span class="p">(</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="p">,</span>
                                <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_input</span><span class="p">[</span><span class="n">key_size_factor</span><span class="p">]),</span> 
                                <span class="n">data</span> <span class="o">=</span> <span class="n">df_input</span><span class="p">,</span>
                                <span class="n">family</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">NegativeBinomial</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

            <span class="n">glm_ref_result</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">glm</span><span class="p">(</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula_ref</span><span class="p">,</span>
                                        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_input</span><span class="p">[</span><span class="n">key_size_factor</span><span class="p">]),</span> 
                                        <span class="n">data</span> <span class="o">=</span> <span class="n">df_input</span><span class="p">,</span>
                                        <span class="n">family</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">NegativeBinomial</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GLM can not be fitted for gene: &#39;</span> <span class="o">+</span> <span class="n">gene</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="c1"># likelihood ratio test</span>
        <span class="k">if</span> <span class="n">adjust_batch</span><span class="p">:</span>
            <span class="n">covariates_cp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glm_result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="p">(</span><span class="n">key_batch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">covariates_cp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glm_result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">L1</span> <span class="o">=</span> <span class="n">glm_result</span><span class="o">.</span><span class="n">llf</span>
        <span class="n">L2</span> <span class="o">=</span> <span class="n">glm_ref_result</span><span class="o">.</span><span class="n">llf</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">LRT</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">)</span>

        <span class="c1"># add multiple comparison here</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">glm_result</span><span class="o">.</span><span class="n">params</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">betas</span><span class="p">[</span><span class="n">covariates_cp</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">glm_result</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Value Error occurred for gene &#39;</span> <span class="o">+</span> <span class="n">gene</span> <span class="o">+</span> <span class="s1">&#39; with error information: need covariance of parameters for computing (unnormalized) covariances.&#39;</span><span class="p">)</span>
            <span class="n">df_input</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;debug_input_table_&#39;</span> <span class="o">+</span> <span class="n">gene</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">covariates_cp</span><span class="p">,:]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">covariates_cp</span><span class="p">]</span>

        <span class="n">df_pairwiseComp</span> <span class="o">=</span> <span class="n">emmeans</span><span class="p">(</span><span class="n">df_input</span><span class="p">,</span> <span class="n">betas</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">key_cell</span> <span class="o">=</span> <span class="n">key_celltype</span><span class="p">,</span> <span class="n">key_perturb</span> <span class="o">=</span> <span class="n">key_perturb</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">group_control</span><span class="p">)</span>
    
        <span class="c1"># add two columns about pts information</span>
        <span class="n">df_nonzero</span> <span class="o">=</span> <span class="n">df_input</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">df_input</span><span class="p">[</span><span class="n">key_celltype</span><span class="p">],</span> <span class="n">df_input</span><span class="p">[</span><span class="n">key_perturb</span><span class="p">]])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df_input</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">key_celltype</span><span class="p">,</span> <span class="n">key_perturb</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">contrast_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_pairwiseComp</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">],</span> <span class="n">df_pairwiseComp</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">])]</span>
        <span class="n">reference_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_pairwiseComp</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">],</span> <span class="n">df_pairwiseComp</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">])]</span>
        <span class="n">df_pairwiseComp</span><span class="p">[</span><span class="s1">&#39;pts_contrast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_nonzero</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">contrast_tuples</span><span class="p">])</span>
        <span class="n">df_pairwiseComp</span><span class="p">[</span><span class="s1">&#39;pts_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_nonzero</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reference_tuples</span><span class="p">])</span>

        <span class="n">df_pairwiseComp</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene</span>
        <span class="n">df_pairwiseComp_chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pairwiseComp_chunk</span><span class="p">,</span> <span class="n">df_pairwiseComp</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># format output</span>
        <span class="n">conf_int</span> <span class="o">=</span> <span class="n">glm_result</span><span class="o">.</span><span class="n">conf_int</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">covariates_cp</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">conf_int</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;lower bound&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;upper bound&#39;</span><span class="p">},</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="n">pvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">glm_result</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="n">covariates_cp</span><span class="p">])</span>
        <span class="n">pvals</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;pvals&#39;</span><span class="p">},</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">std_errs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">glm_result</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">covariates_cp</span><span class="p">])</span>
        <span class="n">std_errs</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;standard err&#39;</span><span class="p">},</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">mu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">glm_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">covariates_cp</span><span class="p">])</span>
        <span class="n">mu</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;mu&#39;</span><span class="p">},</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># add coefficient metadat onto the table</span>
        <span class="n">df_meta_coeffs</span> <span class="o">=</span> <span class="n">extract_covar_name</span><span class="p">(</span><span class="n">conf_int</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">key_celltype</span><span class="p">,</span> <span class="n">key_perturb</span><span class="p">)</span>        
        
        <span class="n">df_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_meta_coeffs</span><span class="p">,</span> <span class="n">conf_int</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">std_errs</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">df_output</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene</span>
        <span class="n">df_output</span><span class="p">[</span><span class="s1">&#39;LRT_pval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">df_output_chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_output_chunk</span><span class="p">,</span> <span class="n">df_output</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_output_chunk</span><span class="p">,</span> <span class="n">df_pairwiseComp_chunk</span>


<span class="k">def</span> <span class="nf">model_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_processes</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">adjust_batch</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">add_dummy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pairwise_contrast_only</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output_suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build a model for each gene and curate predictions from iterations.</span>
<span class="sd">    Multiprocessing is used here.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata</span>
<span class="sd">        anndata</span>
<span class="sd">    n_processes</span>
<span class="sd">        number of processes to be used</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># initialization</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Start to run the model.&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Number of processes: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_processes</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Chunksize: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunksize</span><span class="p">))</span>

    <span class="k">global</span> <span class="n">key_celltype</span><span class="p">;</span> <span class="k">global</span> <span class="n">key_perturb</span><span class="p">;</span> <span class="k">global</span> <span class="n">key_size_factor</span><span class="p">;</span> <span class="k">global</span> <span class="n">key_batch</span><span class="p">;</span> <span class="k">global</span> <span class="n">group_control</span>
    
    <span class="n">key_celltype</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;cell_type_key&#39;</span><span class="p">]</span>
    <span class="n">key_perturb</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;perturb_key&#39;</span><span class="p">]</span>
    <span class="n">key_size_factor</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;size_factor_key&#39;</span><span class="p">]</span>    
    <span class="n">key_batch</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;batch_key&#39;</span><span class="p">]</span>  
    <span class="n">group_control</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;group_control&#39;</span><span class="p">]</span>
    <span class="n">n_coeffs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key_perturb</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>  <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">key_celltype</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span>

    <span class="n">genes</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">n_genes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">key_batch</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_meta</span> <span class="o">=</span>  <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="n">key_celltype</span><span class="p">,</span><span class="n">key_perturb</span><span class="p">,</span> <span class="n">key_size_factor</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># extract cell type and perturbation columns </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_meta</span> <span class="o">=</span>  <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="n">key_celltype</span><span class="p">,</span><span class="n">key_perturb</span><span class="p">,</span> <span class="n">key_size_factor</span><span class="p">,</span> <span class="n">key_batch</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># extract cell type and perturbation columns </span>

    <span class="c1"># batch (batch preparation is to avoid large dense tables)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_processes</span> <span class="o">*</span> <span class="n">chunksize</span> <span class="c1"># 800 or 1600</span>
    <span class="n">final_batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_genes</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Start to run batch: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">))</span>
        
        <span class="c1"># prepare huge expression table for all chunks in one batch</span>
        <span class="n">genes_idx_batch</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_genes</span><span class="p">))</span>
        <span class="n">genes_batch</span> <span class="o">=</span> <span class="n">genes</span><span class="p">[</span><span class="n">genes_idx_batch</span><span class="p">]</span>
        <span class="n">df_batch_expr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">genes_idx_batch</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span>
                                    <span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">columns</span> <span class="o">=</span> <span class="n">genes_batch</span><span class="p">)</span>
        <span class="n">df_batch_input</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_meta</span><span class="p">,</span> <span class="n">df_batch_expr</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Size of input table: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">df_batch_input</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; Mb.&#39;</span><span class="p">)</span>

        <span class="c1"># separate batch table into chunks</span>
        <span class="n">genes_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">df_chunks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">chunk_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">):</span>
            <span class="n">genes_chunk</span> <span class="o">=</span> <span class="n">genes_batch</span><span class="p">[</span><span class="n">chunk_idx</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunk_idx</span> <span class="o">+</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)]</span>
            <span class="n">genes_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genes_chunk</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">genes_chunk</span><span class="p">)</span>
            <span class="n">df_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_batch_input</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        
        <span class="c1"># multiprocessing</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span> <span class="o">=</span> <span class="n">n_processes</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">glm_gene_chunk</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">df_chunk</span><span class="p">,</span> <span class="n">adjust_batch</span><span class="p">,</span> <span class="n">add_dummy</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">df_chunk</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">genes_chunks</span><span class="p">,</span> <span class="n">df_chunks</span><span class="p">)]</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Size of outcome of apply: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">collect</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collect</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        ray.init(num_cpus = n_processes)</span>
<span class="sd">        futures = [glm_gene_chunk.remote(chunk, df_chunk) for (chunk, df_chunk) in zip(genes_chunks, df_chunks)]</span>
<span class="sd">        final = ray.get(futures)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">final_batches</span> <span class="o">+=</span> <span class="n">final</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Finish batch: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">))</span>

    <span class="c1"># concatenate results</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Start to format modeling output&#39;</span><span class="p">)</span>
    <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df_pairwiseComp_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">df_sub</span><span class="p">,</span> <span class="n">df_pairwiseComp_sub</span><span class="p">)</span> <span class="ow">in</span> <span class="n">final_batches</span><span class="p">:</span>
        <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_all</span><span class="p">,</span> <span class="n">df_sub</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_pairwiseComp_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pairwiseComp_all</span><span class="p">,</span> <span class="n">df_pairwiseComp_sub</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">output_suffix</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output_suffix</span>

    <span class="n">df_all</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;GLM_output&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">df_pairwiseComp_all</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;Contrast_Coefficients&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># write / append pairwise comparison results </span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">prepare_output</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">df_all</span><span class="p">,</span> 
        <span class="n">df_pairwiseComp_all</span><span class="p">,</span> 
        <span class="n">n_coeffs</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">,</span> 
        <span class="n">suffix</span><span class="p">,</span> 
        <span class="n">pairwise_contrast_only</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">adata</span>

<span class="k">def</span> <span class="nf">model_selection</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">pval_LRT</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">pval_multicomp</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Select model for better downstream analysis</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># categorize genes using </span>
    <span class="n">df_genes</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">df_multicomp_pvals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;Contrast_Coefficients_pvals&#39;</span><span class="p">],</span> 
                                    <span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> 
                                    <span class="n">columns</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;multicomp_terms&#39;</span><span class="p">])</span>

    <span class="n">genes_perturbed</span> <span class="o">=</span> <span class="n">df_multicomp_pvals</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_multicomp_pvals</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pval_multicomp</span><span class="p">]</span>
    <span class="n">genes_perturbed_AcrossTypes</span> <span class="o">=</span> <span class="n">df_genes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_genes</span><span class="p">[</span><span class="s1">&#39;LRT_pvals&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pval_LRT</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Number of perturbed genes: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genes_perturbed</span><span class="p">)))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Number of genes perturbed differently across cell types: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genes_perturbed_AcrossTypes</span><span class="p">)))</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;perturbed_genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;differentially_perturbed_genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genes_perturbed</span><span class="p">,</span> <span class="s1">&#39;perturbed_genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genes_perturbed_AcrossTypes</span><span class="p">,</span> <span class="s1">&#39;differentially_perturbed_genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">adata</span>

<span class="k">def</span> <span class="nf">organize_output</span><span class="p">(</span><span class="n">rep_id</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Contrast_Coefficients_time&#39;</span><span class="p">))]</span>

    <span class="n">df_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rep&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;perturbation&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_type&#39;</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">output_files</span><span class="p">)):</span>    
        <span class="c1"># get basic information</span>
        <span class="n">df_pairwise</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_folder</span> <span class="o">+</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">output_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Contrast_Coefficients_time_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]))</span>
        <span class="n">n_perts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">]))</span>
        <span class="n">n_genes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]))</span>

        <span class="c1"># make graph per (time + pert)</span>
        <span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="n">coeff_vals</span> <span class="o">=</span> <span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;zscore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">n_genes</span><span class="p">,</span> <span class="n">n_types</span> <span class="o">*</span> <span class="n">n_perts</span><span class="p">])</span>

        <span class="n">genes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pairwise</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span> <span class="s1">&#39;perturbation&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">])[</span><span class="s1">&#39;gene&#39;</span><span class="p">][</span> <span class="p">:</span> <span class="n">n_genes</span><span class="p">])</span>
        <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;rep&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rep_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;contrast&#39;</span><span class="p">][</span> <span class="p">:</span> <span class="n">n_types</span> <span class="o">*</span> <span class="n">n_perts</span><span class="p">])]</span>
        <span class="n">avail_types</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">][:(</span><span class="n">n_types</span> <span class="o">*</span> <span class="n">n_perts</span><span class="p">)])]</span>
        <span class="n">avail_perts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pairwise</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">][:(</span><span class="n">n_types</span> <span class="o">*</span> <span class="n">n_perts</span><span class="p">)])]</span>
        
        <span class="n">df_graph</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">coeff_vals</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">genes</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">contrasts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df_combined</span> <span class="o">=</span> <span class="n">df_graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_combined</span><span class="p">,</span> <span class="n">df_graph</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">join</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">pert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contrasts</span><span class="p">,</span> <span class="n">avail_types</span><span class="p">,</span> <span class="n">avail_perts</span><span class="p">):</span>
            <span class="n">df_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">contrast</span><span class="p">,</span> <span class="p">:</span> <span class="p">]</span> <span class="o">=</span>  <span class="p">[</span><span class="n">rep_id</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">pert</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">]</span>

    <span class="n">df_combined</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df_combined</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># remove nan values in the output</span>

    <span class="k">return</span> <span class="n">df_combined</span><span class="p">,</span> <span class="n">df_meta</span>

<div class="viewcode-block" id="model_timescale"><a class="viewcode-back" href="../../apis.html#CellDrift._model.model_timescale">[docs]</a><span class="k">def</span> <span class="nf">model_timescale</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_processes</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">adjust_batch</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">add_dummy</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pairwise_contrast_only</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output_suffix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    run the GLM model across multiple time points. Also refer to model_genes to see model for one time point.</span>

<span class="sd">    :param adata: CellDrift anndata after running setup_celldrift.</span>
<span class="sd">    :param n_processes: number of processors for multiprocessing. Default is 16.</span>
<span class="sd">    :param chunksize: number of genes for each processor. Default is 100.</span>
<span class="sd">    :param adjust_batch: whether to adjust batch effect in the generalized linear model. Default is True.</span>
<span class="sd">    :param add_dummy: whether to add dummy values to resolve the sparse input of single-cell data. (Not implemented)</span>
<span class="sd">    :param pairwise_contrast_only: whether to output pairwise contrast coefficients only. Default is False, which means the results also include other output from the GLM model.</span>
<span class="sd">    :param output_suffix: suffix characters to be added in each output file. Default is None.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># initialization</span>
    <span class="n">time_key</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;time_key&#39;</span><span class="p">]</span>
    <span class="n">pert_key</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;perturb_key&#39;</span><span class="p">]</span>
    <span class="n">ctrl_name</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;group_control&#39;</span><span class="p">]</span>
    <span class="n">time_points</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">time_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span>
    <span class="n">temporal_dir</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;temporal_dir&#39;</span><span class="p">]</span>
    <span class="n">n_reps</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;n_reps&#39;</span><span class="p">]</span>
    <span class="n">key_reps</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;rep_key&#39;</span><span class="p">]</span>
    <span class="n">df_meta</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">output_suffix</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output_suffix</span>

    <span class="c1"># run GLM for each replicates</span>
    <span class="n">df_zscores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">df_zscores_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">rep_id</span><span class="p">,</span> <span class="n">rep_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">key_reps</span><span class="p">)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Run GLM model for replicate &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rep_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">cells_rep</span> <span class="o">=</span> <span class="n">df_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_meta</span><span class="p">[</span><span class="n">rep_name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">adata_rep</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">cells_rep</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">output_dir_rep</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="n">rep_name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="n">rep_name</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="n">rep_name</span><span class="p">)</span>
        <span class="n">adata_rep</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;celldrift&#39;</span><span class="p">][</span><span class="s1">&#39;output_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir_rep</span>
        <span class="n">adata_rep</span> <span class="o">=</span> <span class="n">update_celldrift</span><span class="p">(</span><span class="n">adata_rep</span><span class="p">)</span>

        <span class="c1"># run GLM for each time points</span>
        <span class="c1"># for time in tqdm(time_points):</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">time_points</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---Step2: Run GLM model for time point &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>

            <span class="n">adata_time</span> <span class="o">=</span> <span class="n">adata_rep</span><span class="p">[(</span><span class="n">adata_rep</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">time_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">adata_rep</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">pert_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">ctrl_name</span><span class="p">),</span> <span class="p">:</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">adata_time</span> <span class="o">=</span> <span class="n">update_celldrift</span><span class="p">(</span><span class="n">adata_time</span><span class="p">)</span>
            <span class="n">adata_time</span> <span class="o">=</span> <span class="n">model_genes</span><span class="p">(</span>
                <span class="n">adata_time</span><span class="p">,</span> 
                <span class="n">n_processes</span><span class="p">,</span> 
                <span class="n">chunksize</span><span class="p">,</span> 
                <span class="n">adjust_batch</span><span class="p">,</span> 
                <span class="n">add_dummy</span><span class="p">,</span> 
                <span class="n">pairwise_contrast_only</span><span class="p">,</span> 
                <span class="n">output_suffix</span> <span class="o">=</span> <span class="s1">&#39;_time_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="p">)</span> <span class="c1"># GLM</span>
            <span class="n">adata_time</span> <span class="o">=</span> <span class="n">model_selection</span><span class="p">(</span><span class="n">adata_time</span><span class="p">)</span> <span class="c1"># LRT</span>
            <span class="n">adata_time</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_dir_rep</span> <span class="o">+</span> <span class="s1">&#39;CellDrift_object_time_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.h5ad&#39;</span><span class="p">)</span>

        <span class="c1"># organize the output</span>
        <span class="n">df_zscores_rep</span><span class="p">,</span> <span class="n">df_zscores_metadata_rep</span> <span class="o">=</span> <span class="n">organize_output</span><span class="p">(</span>
            <span class="n">rep_id</span> <span class="o">=</span> <span class="n">rep_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
            <span class="n">output_folder</span> <span class="o">=</span> <span class="n">output_dir_rep</span>
        <span class="p">)</span>
        <span class="n">df_zscores_rep</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir_rep</span> <span class="o">+</span> <span class="s1">&#39;Contrast_Coefficients_combined_zscores_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">df_zscores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_zscores</span><span class="p">,</span> <span class="n">df_zscores_rep</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">join</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="n">df_zscores_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_zscores_metadata</span><span class="p">,</span> <span class="n">df_zscores_metadata_rep</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># write output files</span>
    <span class="n">df_zscores</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">temporal_dir</span> <span class="o">+</span> <span class="s1">&#39;Contrast_Coefficients_combined_zscores_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">df_zscores_metadata</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">temporal_dir</span> <span class="o">+</span> <span class="s1">&#39;Contrast_Coefficients_combined_metadata_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kang Jin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>